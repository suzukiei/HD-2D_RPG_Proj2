# バフ処理実装に必要な要素

## 概要

バフ（強化効果）システムを実装するために必要な要素を洗い出したドキュメントです。

---

## 1. バフの基本定義

### 1.1 バフの種類
- [x] **ステータス強化バフ**
  - [x] STR（物理攻撃力）上昇
  - [ ] INT（魔法攻撃力）上昇
  - [ ] VIT（体力/防御力）上昇
  - [ ] AGI（敏捷性/速度）上昇
  - [ ] その他のステータス上昇

- [ ] **防御系バフ**
  - [ ] 物理ダメージ軽減
  - [ ] 魔法ダメージ軽減
  - [ ] 状態異常耐性上昇
  - [ ] 無敵時間付与

### 1.2 バフの識別情報
- [ ] **バフID**: 一意の識別子
- [x] **バフ名**: 表示用の名前
- [x] **バフ説明**: 効果の説明文
- [ ] **バフアイコン**: UI表示用のアイコン
- [ ] **バフタイプ**: カテゴリ分類（攻撃系/防御系/特殊系など）

---

## 2. バフの効果定義

### 2.1 効果の種類
- [ ] **固定値増減**: ステータスに固定値を加算/減算
- [x] **パーセンテージ増減**: ベースステータスに対する割合で増減（AttackUpBuffで実装）
- [ ] **最大値/最小値制限**: ステータスの上限・下限設定
- [x] **計算式への影響**: ダメージ計算式への係数適用

### 2.2 影響を受けるステータス
- [x] STR（物理攻撃力）
- [ ] INT（魔法攻撃力）
- [ ] VIT（体力/防御力）
- [ ] AGI（敏捷性）
- [ ] HP（現在体力）
- [ ] MP（現在マナ）
- [ ] その他のカスタムステータス

### 2.3 効果の適用タイミング
- [x] **即座に適用**: バフ付与時に即座に効果発動
- [ ] **ターン開始時**: ターンの開始時に効果適用
- [ ] **ターン終了時**: ターンの終了時に効果適用
- [x] **ダメージ計算時**: ダメージ計算の際に効果適用
- [ ] **特定アクション時**: 特定のアクション実行時に効果適用

---

## 6. バフの適用条件

### 6.1 付与条件
- [x] **スキル使用時**: 特定のスキル使用で付与
- [ ] **アイテム使用時**: 特定のアイテム使用で付与
- [ ] **装備時**: 特定の装備をしている時に付与
- [ ] **状態条件**: HPが一定以下など、状態による付与
- [ ] **ターン条件**: 特定のターン数で付与
- [ ] **イベント条件**: 特定のイベント発生時に付与

### 6.2 適用対象
- [x] **自分自身**: バフを付与したキャラクター自身
- [x] **味方全体**: 味方全員に適用
- [x] **味方単体**: 特定の味方1体に適用
- [ ] **範囲内の味方**: 範囲内の味方に適用
- [x] **敵**: 敵に適用（デバフとして）

---

## 7. バフの解除条件

### 7.1 自動解除
- [x] **時間経過**: 持続時間が経過したら自動解除
- [x] **ターン経過**: 指定ターン数経過で自動解除
- [ ] **スタック数減少**: スタック数が0になったら解除

### 7.2 条件解除
- [ ] **特定スキル使用時**: 解除スキル使用で解除
- [ ] **特定アイテム使用時**: 解除アイテム使用で解除
- [ ] **状態異常付与時**: 特定の状態異常で解除
- [ ] **HP/MP条件**: HPやMPが一定値になったら解除
- [ ] **戦闘終了時**: 戦闘終了で解除

### 7.3 強制解除
- [ ] **デバフによる解除**: 特定のデバフで強制解除
- [ ] **死亡時**: キャラクター死亡で解除
- [ ] **手動解除**: プレイヤーが手動で解除

---

## 8. データ構造

### 8.1 バフデータクラス
```python
# 疑似コード
class BuffData:
    buff_id: int              # バフID
    buff_name: str            # バフ名
    buff_description: str     # 説明
    buff_type: BuffType       # バフタイプ
    icon_path: str            # アイコンパス
    
    # 効果定義
    effect_type: EffectType   # 効果の種類
    target_stat: StatType     # 対象ステータス
    value: float              # 効果値（固定値）
    percentage: float         # 効果値（パーセンテージ）
    
    # 時間管理
    duration_type: DurationType  # 持続時間の種類
    duration: int                # 持続時間（ターン数または秒数）
    
    # スタック
    stackable: bool           # スタック可能か
    max_stack: int           # 最大スタック数
    
    # 優先度・強度
    priority: int            # 優先度
    strength: int            # 強度
    
    # 条件
    apply_condition: Condition  # 適用条件
    remove_condition: Condition # 解除条件
```

### 8.2 バフインスタンスクラス
```python
# 疑似コード
class BuffInstance:
    buff_data: BuffData      # バフデータへの参照
    target: Character        # 適用対象キャラクター
    applied_time: float      # 適用時刻
    remaining_turns: int     # 残りターン数
    remaining_time: float    # 残り時間（秒）
    stack_count: int        # 現在のスタック数
    applied_by: Character    # バフを付与したキャラクター
```

### 8.3 バフ管理クラス
```python
# 疑似コード
class BuffManager:
    active_buffs: List[BuffInstance]  # アクティブなバフリスト
    
    def apply_buff(buff_data, target, applied_by)
    def remove_buff(buff_instance)
    def update_buffs(delta_time)
    def get_stat_modifier(stat_type)
    def has_buff(buff_id)
    def get_buff_stack_count(buff_id)
```

---

## 9. ステータス計算への統合

### 9.1 計算式への組み込み
- [x] **ベースステータス取得**: キャラクターのベースステータスを取得
- [x] **バフ効果の適用**: アクティブなバフ効果を全て適用
- [x] **最終ステータス計算**: バフ適用後の最終ステータスを計算
- [x] **ダメージ計算式への反映**: 計算式で最終ステータスを使用

### 9.2 既存の計算式との統合
既存の仕様書によると、以下の計算式が存在：
- **物理攻撃**: `（STR～STR×2の最大値）＝基礎値`
- **魔法攻撃**: `（INT～INT×2の最大値）＝基礎値`
- **状態異常確率**: `(自身のINT-相手のINT)×5＋使用者のLV％`

バフシステムでは：
- [x] STR/INTにバフ効果を適用してから計算式に使用
- [ ] 状態異常確率計算にもINTバフを反映
- [ ] その他の計算式にも適切にバフ効果を反映

---

## 10. UI表示

### 10.1 バフ表示の場所
- [ ] **キャラクターステータス画面**: 詳細なバフ情報を表示
- [ ] **バトル画面**: 戦闘中のバフを表示
- [ ] **アイコン表示**: キャラクターの上や横にバフアイコンを表示
- [ ] **ツールチップ**: アイコンにマウスオーバーで詳細表示

### 10.2 表示する情報
- [ ] **バフアイコン**: 視覚的な識別
- [ ] **バフ名**: バフの名前
- [ ] **残り時間/ターン数**: 持続時間の表示
- [ ] **スタック数**: スタック可能な場合のスタック数
- [ ] **効果の説明**: バフの効果内容

### 10.3 視覚的表現
- [ ] **アイコンの色分け**: バフタイプで色分け
- [ ] **エフェクト表示**: バフ適用時のエフェクト
- [ ] **アニメーション**: 時間経過のアニメーション
- [ ] **点滅表示**: 残り時間が少ない時の警告表示

---

## 11. 実装に必要なクラス設計

### 11.1 コアクラス
- [x] **BuffData**: バフの定義データ（BuffBaseとして実装）
- [x] **BuffInstance**: バフのインスタンス（実際に適用されているバフ）
- [x] **BuffManager**: バフの管理クラス（CharacterBuffManagerとして実装）
- [ ] **BuffType**: バフタイプの列挙型
- [x] **EffectType**: 効果タイプの列挙型（BuffEffectTypeとして実装）
- [ ] **DurationType**: 持続時間タイプの列挙型

### 11.2 統合クラス
- [x] **CharacterStatus**: キャラクターステータス管理（バフ効果を反映）（CharacterBuffManagerとして実装）
- [x] **BattleSystem**: バトルシステム（バフのターン管理）（TurnManagerとPlayerManagerで実装）
- [x] **SkillSystem**: スキルシステム（バフ付与スキルの処理）（PlayerManagerで実装）
- [ ] **ItemSystem**: アイテムシステム（バフ付与アイテムの処理）

### 11.3 UIクラス
- [ ] **BuffIcon**: バフアイコンの表示
- [ ] **BuffTooltip**: バフのツールチップ表示
- [ ] **BuffListUI**: バフリストのUI表示

---

## 12. 既存仕様書との関連

### 12.1 既存の情報
既存の仕様書から確認できた関連情報：
- **ステータス・スキルシート**: 状態異常確率の計算式が存在
- **ダメージ計算式**: STR/INTベースの計算式が存在
- **レベルシステム**: レベルによる成長システムが存在

### 12.2 追加が必要な情報
- [ ] **バフ一覧表**: ゲーム内の全バフの定義
- [ ] **バフ付与スキル一覧**: どのスキルがどのバフを付与するか
- [ ] **バフ付与アイテム一覧**: どのアイテムがどのバフを付与するか
- [ ] **バフの優先度表**: 各バフの優先度と強度の定義
- [ ] **バフのスタックルール**: 各バフのスタック可否と上限

---

## 13. 実装の優先順位

### 13.1 フェーズ1: 基本実装
1. [ ] BuffDataクラスの定義
2. [ ] BuffInstanceクラスの定義
3. [ ] BuffManagerクラスの基本機能（適用・解除）
4. [ ] ステータス計算への統合

### 13.2 フェーズ2: 時間管理
1. [ ] ターン数での持続時間管理
2. [ ] 実時間での持続時間管理
3. [ ] 時間経過による自動解除

### 13.3 フェーズ3: スタック機能
1. [ ] スタック可能なバフの実装
2. [ ] スタック数の管理
3. [ ] スタック時の効果計算

### 13.4 フェーズ4: UI実装
1. [ ] バフアイコンの表示
2. [ ] バフ情報の表示
3. [ ] ツールチップ表示

### 13.5 フェーズ5: 高度な機能
1. [ ] 優先度システム
2. [ ] 条件付きバフ
3. [ ] バフの連鎖効果

---

## 14. テスト項目

### 14.1 基本機能テスト
- [ ] バフの適用が正しく動作するか
- [ ] バフの解除が正しく動作するか
- [ ] ステータスへの影響が正しく反映されるか
- [ ] 時間経過で自動解除されるか

### 14.2 スタック機能テスト
- [ ] スタック可能なバフが正しくスタックされるか
- [ ] スタック数の上限が正しく機能するか
- [ ] スタック時の効果計算が正しいか

### 14.3 統合テスト
- [ ] ダメージ計算式にバフ効果が正しく反映されるか
- [ ] 状態異常確率計算にバフ効果が正しく反映されるか
- [ ] 複数のバフが同時に適用された時の動作確認

### 14.4 UIテスト
- [ ] バフアイコンが正しく表示されるか
- [ ] 残り時間が正しく表示されるか
- [ ] ツールチップが正しく表示されるか

---

## 15. 注意事項

### 15.1 パフォーマンス
- [ ] 大量のバフが同時に適用された時のパフォーマンス考慮
- [ ] バフ更新処理の最適化
- [ ] UI更新の最適化

### 15.2 バランス調整
- [ ] バフ効果の強さのバランス調整
- [ ] 持続時間のバランス調整
- [ ] スタック上限のバランス調整

### 15.3 拡張性
- [ ] 新しいバフタイプの追加が容易か
- [ ] カスタム効果の追加が容易か
- [ ] データ駆動型の設計か

---

## 16. 既存実装の分析と改善点

### 16.1 既存実装の現状
既存コードを確認した結果、以下の実装が存在：
- [x] `BuffBase`クラス（抽象クラス）
- [x] `BuffInstance`クラス（バフインスタンス管理）
- [x] `PlayerManager`でのバフ適用処理
- [x] ターン管理によるバフの自動解除
- [x] `AttackUpBuff`の実装例

### 16.2 既存実装の問題点
- [x] **バフ管理の分散**: `PlayerManager`に全バフが集約されており、キャラクターごとの管理がない
- [x] **ステータス計算の問題**: `AttackUpBuff`が直接`target.atk`を変更しており、複数バフ適用時に問題が発生
- [x] **ベースステータスの保持**: 元のステータス値を保持する仕組みが不十分
- [x] **ダメージ計算への統合不足**: `ApplyAttack`メソッドでバフ効果が考慮されていない
- [ ] **スタック処理の未実装**: 同じバフの重複適用時の処理がない
- [x] **バフの対象管理**: `BuffInstance`に`target`フィールドがない

### 16.3 改善が必要な実装
- [x] **キャラクターごとのバフ管理**: 各`Character`に`CharacterBuffManager`を追加
- [x] **ステータス計算の分離**: ベースステータスとバフ適用後のステータスを分離
- [ ] **バフ効果の計算方法統一**: 加算/乗算の処理を統一
- [x] **ダメージ計算への統合**: `ApplyAttack`でバフ効果を反映

---

## 17. キャラクターごとのバフ管理

### 17.1 CharacterBuffManagerクラス
- [x] **各CharacterにBuffManagerを追加**: キャラクターごとにバフを管理
- [x] **バフリストの保持**: `List<BuffInstance> activeBuffs`を各キャラクターが保持
- [x] **バフの適用/解除**: キャラクター単位でのバフ操作
- [x] **ステータス計算**: バフ効果を反映したステータス取得

### 17.2 Characterクラスへの統合
- [x] **BuffManagerの追加**: `Character`クラスに`CharacterBuffManager`コンポーネントを追加
- [x] **ステータス取得メソッド**: バフ効果を反映したステータスを取得するメソッド
  - `GetEffectiveAttack()`: バフ適用後の攻撃力
  - `GetEffectiveDefense()`: バフ適用後の防御力
  - `GetEffectiveSpeed()`: バフ適用後の速度
- [x] **ベースステータスの保持**: 元のステータス値を保持するフィールド

### 17.3 実装例
```csharp
// Characterクラスに追加
private CharacterBuffManager buffManager;
private int baseAtk, baseDef, baseSpd; // ベースステータス

public int GetEffectiveAttack()
{
    return buffManager.ApplyBuffsToStat(baseAtk, StatType.Attack);
}
```

---

## 18. ステータス計算の改善

### 18.1 ベースステータスとバフ適用後の分離
- [x] **ベースステータスの保存**: バフ適用前の元のステータスを保持
- [x] **動的ステータス計算**: バフ適用後のステータスを計算時に算出
- [x] **ステータス変更の禁止**: バフ適用時に直接ステータスを変更しない

### 18.2 バフ効果の計算順序
- [ ] **計算順序の定義**: バフ効果を適用する順序を定義
  - 1. 固定値加算バフ
  - 2. パーセンテージ加算バフ
  - 3. パーセンテージ乗算バフ
- [ ] **計算式の統一**: 全てのバフで同じ計算式を使用

### 18.3 既存のAttackUpBuffの改善
- [x] **直接変更の禁止**: `target.atk`を直接変更しない
- [x] **バフ効果の登録**: バフマネージャーに効果を登録する方式に変更
- [x] **複数バフ対応**: 複数の攻撃力バフが同時に適用できるように

---

## 19. ダメージ計算への統合

### 19.1 ApplyAttackメソッドの改善
- [x] **バフ適用後の攻撃力使用**: `selectedCharacter.atk`の代わりに`selectedCharacter.GetEffectiveAttack()`を使用
- [x] **防御力バフの反映**: 敵の防御力にもバフ効果を反映
- [x] **ダメージ計算式の更新**: バフ効果を考慮した計算式に変更

### 19.2 既存の計算式との統合
現在の`ApplyAttack`メソッド：
```csharp
var damage = selectedCharacter.atk * random;
var finalDamage = damage * skill.power - enemy.def;
```

改善後：
```csharp
var effectiveAtk = selectedCharacter.GetEffectiveAttack();
var effectiveDef = enemy.GetEffectiveDefense();
var damage = effectiveAtk * random;
var finalDamage = damage * skill.power - effectiveDef;
```

---

## 20. バフのスタック処理の実装

### 20.1 スタック処理の実装
- [ ] **同じバフの検出**: 既に適用されているバフと同じIDかどうかを判定
- [ ] **スタック可能なバフ**: `BuffBase`に`stackable`フラグを追加
- [ ] **スタック数の管理**: `BuffInstance`に`stackCount`フィールドを追加
- [ ] **スタック時の効果計算**: スタック数に応じて効果を計算

### 20.2 スタック処理のロジック
- [ ] **スタック不可の場合**: 既存のバフを上書きまたは無視
- [ ] **スタック可能の場合**: スタック数を増やし、効果を加算/乗算
- [ ] **スタック上限**: 最大スタック数を超えないように制御

---

## 21. エラーハンドリングとバリデーション

### 21.1 バフ適用時のエラーハンドリング
- [ ] **nullチェック**: バフデータ、対象キャラクターのnullチェック
- [ ] **無効なバフの検出**: 持続時間が0以下のバフを検出
- [ ] **適用失敗時の処理**: バフ適用に失敗した場合のログ出力

### 21.2 バフ解除時のエラーハンドリング
- [ ] **存在しないバフの解除**: 存在しないバフを解除しようとした場合の処理
- [ ] **ステータス復元の失敗**: バフ解除時にステータスが正しく復元されない場合の処理

### 21.3 デバッグ機能
- [ ] **バフ適用のログ**: バフ適用時の詳細ログ
- [ ] **バフ解除のログ**: バフ解除時の詳細ログ
- [ ] **ステータス計算のログ**: バフ効果を適用したステータス計算のログ
- [ ] **バフ一覧の表示**: 現在適用されているバフの一覧を表示

---

## 22. バフの保存と読み込み

### 22.1 戦闘間のバフ保持
- [ ] **バフの永続化**: 戦闘終了後も保持するバフの定義
- [ ] **バフのシリアライズ**: バフデータを保存可能な形式に変換
- [ ] **バフのデシリアライズ**: 保存されたバフデータを読み込み

### 22.2 セーブ/ロード対応
- [ ] **バフデータの保存**: セーブデータにバフ情報を含める
- [ ] **バフデータの読み込み**: ロード時にバフ情報を復元
- [ ] **バフの参照解決**: ScriptableObjectの参照を正しく解決

---

## 23. パフォーマンス最適化

### 23.1 バフ更新の最適化
- [ ] **不要な更新の回避**: 変更がない場合は更新をスキップ
- [ ] **バッチ処理**: 複数のバフ更新をまとめて処理
- [ ] **キャッシュの活用**: 計算結果をキャッシュして再利用

### 23.2 メモリ管理
- [ ] **バフインスタンスの再利用**: 可能な限りインスタンスを再利用
- [ ] **不要なバフの削除**: 期限切れバフの即座削除
- [ ] **メモリリークの防止**: 参照の適切な管理

---

## 24. 視覚的フィードバック

### 24.1 バフ適用時のエフェクト
- [ ] **適用エフェクト**: バフ適用時に視覚的エフェクトを表示
- [ ] **エフェクトの種類**: バフタイプに応じたエフェクトの種類
- [ ] **エフェクトの持続**: エフェクトの表示時間

### 24.2 バフ表示のアニメーション
- [ ] **アイコンのアニメーション**: バフアイコンのアニメーション
- [ ] **残り時間の表示**: 残りターン数の視覚的表示
- [ ] **スタック数の表示**: スタック数の視覚的表示

---

## 25. テストとデバッグ

### 25.1 単体テスト
- [ ] **バフ適用のテスト**: バフが正しく適用されるか
- [ ] **バフ解除のテスト**: バフが正しく解除されるか
- [ ] **スタック処理のテスト**: スタック処理が正しく動作するか
- [ ] **ステータス計算のテスト**: バフ効果が正しくステータスに反映されるか

### 25.2 統合テスト
- [ ] **ダメージ計算のテスト**: バフ効果がダメージ計算に正しく反映されるか
- [ ] **複数バフのテスト**: 複数のバフが同時に適用された時の動作確認
- [ ] **ターン管理のテスト**: ターン経過でバフが正しく解除されるか

### 25.3 エッジケースのテスト
- [ ] **同時適用のテスト**: 同じバフを同時に複数適用した場合
- [ ] **上限値のテスト**: スタック上限に達した場合
- [ ] **負の値のテスト**: バフ効果が負の値の場合

---

## まとめ

バフ処理を実装するためには、上記の要素を全て考慮する必要があります。特に重要なのは：

1. **バフの定義**: どのようなバフが存在するか
2. **効果の計算**: ステータスへの影響をどう計算するか
3. **時間管理**: 持続時間をどう管理するか
4. **スタック処理**: 複数のバフをどう扱うか
5. **UI表示**: プレイヤーにどう情報を伝えるか
6. **既存実装の改善**: 現在の実装の問題点を解決する
7. **キャラクターごとの管理**: 各キャラクターでバフを管理する
8. **ステータス計算の分離**: ベースステータスとバフ適用後のステータスを分離

これらの要素を段階的に実装していくことで、堅牢なバフシステムを構築できます。

---

## 26. 実装済み項目の確認と不足要素の洗い出し

### 26.1 実装済み項目
- [x] `CharacterBuffManager`クラスの作成
- [x] `Character`クラスへのバフ管理統合
- [x] ベースステータスの保持
- [x] バフ適用後のステータス取得メソッド（`GetEffectiveAttack()`、`GetEffectiveDefense()`、`GetEffectiveSpeed()`）
- [x] `AttackUpBuff`の改善（直接変更を避ける方式）
- [x] `PlayerManager`でのバフ管理の分散
- [x] ダメージ計算へのバフ効果統合
- [x] `BuffInstance`に`targetCharacter`フィールド追加
- [x] ターン管理によるバフの自動解除

### 26.2 不足している要素（優先度：高）

#### 26.2.1 BuffBaseクラスの拡張
- [ ] **バフID**: 一意の識別子（現在は`buffName`で識別しているが、IDが必要）
- [ ] **スタック可能フラグ**: `stackable`フィールドの追加
- [ ] **最大スタック数**: `maxStack`フィールドの追加
- [ ] **優先度**: `priority`フィールドの追加
- [ ] **バフアイコン**: UI表示用の`icon`フィールド
- [ ] **バフタイプ**: カテゴリ分類用の`buffType`列挙型

#### 26.2.2 他のバフタイプの実装
- [ ] **防御力上昇バフ** (`DefenseUpBuff`): 防御力を上昇させるバフ
- [ ] **速度上昇バフ** (`SpeedUpBuff`): 速度を上昇させるバフ
- [ ] **固定値加算バフ**: パーセンテージではなく固定値を加算するバフ
- [ ] **HP回復バフ**: ターンごとにHPを回復するバフ
- [ ] **MP回復バフ**: ターンごとにMPを回復するバフ

#### 26.2.3 スタック処理の完全実装
- [ ] **スタック可能なバフの実装**: `stackable`フラグに基づく処理
- [ ] **スタック数の管理**: `BuffInstance`に`stackCount`フィールドを追加
- [ ] **スタック時の効果計算**: スタック数に応じた効果の計算
- [ ] **スタック上限のチェック**: `maxStack`を超えないように制御

#### 26.2.4 バフ効果の計算順序の実装
- [ ] **固定値加算の実装**: 固定値を加算するバフの実装
- [ ] **パーセンテージ加算の実装**: ベースステータスに対する割合で加算
- [ ] **パーセンテージ乗算の実装**: 現在のステータスに対する割合で乗算
- [ ] **計算順序の統一**: 固定値→パーセンテージ加算→パーセンテージ乗算の順で適用

#### 26.2.5 戦闘終了時の処理
- [ ] **戦闘終了時のバフ解除**: 戦闘終了時に全てのバフを解除する処理
- [ ] **永続バフの定義**: 戦闘終了後も保持するバフの定義
- [ ] **バフの永続化フラグ**: `BuffBase`に`persistent`フラグを追加

#### 26.2.6 EnemyManagerでのバフ管理
- [x] **敵キャラクターのバフ管理**: 敵キャラクターにも`CharacterBuffManager`が適用されているか確認
- [x] **敵のバフ適用処理**: 敵がバフを適用する処理の実装
- [x] **敵のバフターン管理**: 敵のターン終了時のバフ更新処理

### 26.3 不足している要素（優先度：中）

#### 26.3.1 UI表示
- [ ] **バフアイコンの表示**: キャラクターの上や横にバフアイコンを表示
- [ ] **バフ情報の表示**: バフ名、残りターン数、効果の説明を表示
- [ ] **ツールチップ表示**: アイコンにマウスオーバーで詳細情報を表示
- [ ] **バフリストUI**: キャラクターステータス画面でのバフ一覧表示
- [ ] **残り時間の視覚的表示**: 残りターン数の表示（数字やバー）

#### 26.3.2 視覚的フィードバック
- [ ] **バフ適用時のエフェクト**: バフ適用時に視覚的エフェクトを表示
- [ ] **バフ解除時のエフェクト**: バフ解除時の視覚的エフェクト
- [ ] **アイコンのアニメーション**: バフアイコンのアニメーション
- [ ] **点滅表示**: 残り時間が少ない時の警告表示

#### 26.3.3 イベントシステム
- [ ] **バフ適用イベント**: バフ適用時にイベントを発火
- [ ] **バフ解除イベント**: バフ解除時にイベントを発火
- [ ] **バフ期限切れイベント**: バフが期限切れになった時にイベントを発火
- [ ] **ステータス変更イベント**: バフによるステータス変更時にイベントを発火

#### 26.3.4 優先度システム
- [ ] **優先度の実装**: `BuffBase`に`priority`フィールドを追加
- [ ] **優先度による上書き**: 高い優先度のバフが低い優先度のバフを上書き
- [ ] **優先度による共存**: 異なる優先度のバフは共存可能

### 26.4 不足している要素（優先度：低）

#### 26.4.1 バフの保存と読み込み
- [ ] **バフデータのシリアライズ**: バフデータを保存可能な形式に変換
- [ ] **バフデータのデシリアライズ**: 保存されたバフデータを読み込み
- [ ] **ScriptableObjectの参照解決**: セーブ/ロード時の参照解決

#### 26.4.2 パフォーマンス最適化
- [ ] **ステータス計算のキャッシュ**: 計算結果をキャッシュして再利用
- [ ] **不要な更新の回避**: 変更がない場合は更新をスキップ
- [ ] **バッチ処理**: 複数のバフ更新をまとめて処理

#### 26.4.3 デバッグ機能
- [ ] **バフ一覧の表示**: 現在適用されているバフの一覧を表示するデバッグ機能
- [ ] **ステータス計算のログ**: バフ効果を適用したステータス計算の詳細ログ
- [ ] **バフ適用/解除のログ**: バフ適用/解除時の詳細ログ

#### 26.4.4 テスト
- [ ] **単体テスト**: 各機能の単体テスト
- [ ] **統合テスト**: 複数の機能を組み合わせた統合テスト
- [ ] **エッジケースのテスト**: 特殊な状況での動作確認

---

## 27. 実装の優先順位（推奨）

### フェーズ1: 基本機能の完成（最優先）
1. [ ] `BuffBase`クラスの拡張（ID、スタックフラグ、アイコンなど）
2. [ ] 他のバフタイプの実装（防御力、速度など）
3. [ ] スタック処理の完全実装
4. [ ] 戦闘終了時のバフ解除処理
5. [ ] `EnemyManager`でのバフ管理確認

### フェーズ2: UIと視覚的フィードバック
1. [ ] バフアイコンの表示
2. [ ] バフ情報の表示
3. [ ] バフ適用時のエフェクト
4. [ ] ツールチップ表示

### フェーズ3: 高度な機能
1. [ ] イベントシステム
2. [ ] 優先度システム
3. [ ] 固定値加算バフの実装
4. [ ] 計算順序の統一

### フェーズ4: 最適化とテスト
1. [ ] パフォーマンス最適化
2. [ ] デバッグ機能
3. [ ] テストの実装
4. [ ] バフの保存/読み込み

---

## 28. 具体的な実装が必要な項目

### 28.1 即座に実装すべき項目

#### 28.1.1 BuffBaseクラスの拡張
```csharp
public abstract class BuffBase : ScriptableObject
{
    [Header("基本情報")]
    public string buffId;              // 一意のID
    public string buffName;
    public Sprite icon;                // アイコン
    public BuffType buffType;          // バフタイプ
    
    [Header("スタック設定")]
    public bool stackable = false;     // スタック可能か
    public int maxStack = 1;           // 最大スタック数
    
    [Header("優先度")]
    public int priority = 0;           // 優先度（高いほど優先）
    
    [Header("持続時間")]
    public int duration;
    public bool persistent = false;    // 戦闘終了後も保持するか
    
    // 既存のフィールド...
}
```

#### 28.1.2 DefenseUpBuffの実装
```csharp
[CreateAssetMenu(menuName = "RPG/Buffs/DefenseUp")]
public class DefenseUpBuff : BuffBase
{
    public float defenseMultiplier = 1.5f;
    // AttackUpBuffと同様の実装
}
```

#### 28.1.3 スタック処理の改善
- `BuffInstance`に`stackCount`フィールドを追加
- `CharacterBuffManager`の`HandleStack`メソッドを改善
- スタック数に応じた効果計算の実装

#### 28.1.4 戦闘終了時の処理
- `TurnManager`の`VictoryProcess`と`DefeatProcess`でバフ解除
- 永続バフのチェック処理

---

## まとめ（更新版）

実装済みの基本機能に加えて、以下の要素が不足しています：

### 最優先で実装すべき項目
1. **BuffBaseクラスの拡張**: ID、スタックフラグ、アイコン、優先度など
2. **他のバフタイプ**: 防御力、速度などのバフ実装
3. **スタック処理の完全実装**: スタック可能なバフの実装
4. **戦闘終了時の処理**: バフ解除と永続バフの処理
5. **EnemyManagerでのバフ管理**: 敵キャラクターのバフ管理確認

### 次に実装すべき項目
1. **UI表示**: バフアイコン、情報表示、ツールチップ
2. **視覚的フィードバック**: エフェクト、アニメーション
3. **イベントシステム**: バフ適用/解除時のイベント

### 将来的に実装すべき項目
1. **保存/読み込み**: セーブ/ロード対応
2. **パフォーマンス最適化**: キャッシュ、バッチ処理
3. **テスト**: 単体テスト、統合テスト

これらの要素を段階的に実装していくことで、完全なバフシステムを構築できます。
